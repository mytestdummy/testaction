# Lighthouse-Badger | GitHub Action
# 
# Description: Generates, adds & updates manually/automatically Lighthouse badges & reports from one/multiple input URL(s) to a selected target repository
# Author: Sitdisch
# Version: v1.1
# Source: https://github.com/myactionway/lighthouse-badger-action
# License: MIT
# Copyright (c) 2021 Sitdisch

name: 'Lighthouse-Badger'
author: 'Sitdisch'
description: "Generates, adds & updates manually/automatically Lighthouse badges & reports from 1,2... input URL(s) to a target repository"
branding:
  icon: bold
  color: purple

inputs:
  urls:
    description: 'URL(s) to be checked'
    required: true
  badges-args:
    description: 'Badges arguments: -b, -l, -o, -r, -s'
    required: true
  results-type:
    description: 'Results type: mobile, desktop or both'
    required: true
  mobile-lighthouse-params:
    description: 'Lighthouse parameters mobile audit'
    required: true
  desktop-lighthouse-params:
    description: 'Lighthouse parameters desktop audit'
    required: true
  user-name:
    description: 'User who should commit'
    required: true
  user-email:
    description: 'User e-mail address'
    required: true
  commit-message:
    description: 'Commit message'
    required: true

runs:
  using: "composite"
  steps:
    - name: Preparatory Tasks
      run: |
        echo 'RESULTS_PATH=`expr "${{ inputs.badges-args }}" : ".* --\?ou\?t\?p\?u\?t\?-\?p\?a\?t\?h\? \([^ ]*\).*"`' >> $GITHUB_ENV
        echo 'BADGES_ARGS=$(sed -e "s/ \(\(--output-path\)\|\(-o\)\) \S*//g" <<< "${{ inputs.badges-args }}" )' >> $GITHUB_ENV
      shell: bash
    - name: Create Results
      run: |
        mkdir -p ${{ env.RESULTS_PATH }}
        cd temp_lighthouse_badges_nested
        if [ ${{ inputs.results-type }} = "both" ]; then
          { export LIGHTHOUSE_BADGES_PARAMS="${{ inputs.mobile-lighthouse-params }}"; ./src/index.js -u ${{ inputs.urls }} ${{ env.BADGES_ARGS }} -o mobile; cp -r mobile ../${{ env.RESULTS_PATH }}; rm -R mobile; } & 
          { export LIGHTHOUSE_BADGES_PARAMS="${{ inputs.desktop-lighthouse-params }}"; ./src/index.js -u ${{ inputs.urls }} ${{ env.BADGES_ARGS }} -o desktop; cp -r desktop ../${{ env.RESULTS_PATH }}; rm -R desktop; } &
          wait
        else
          if [ ${{ inputs.results-type }} = "mobile" ]; then
            export LIGHTHOUSE_BADGES_PARAMS="${{ inputs.mobile-lighthouse-params }}"
          else
            export LIGHTHOUSE_BADGES_PARAMS="${{ inputs.desktop-lighthouse-params }}"
          fi
          ./src/index.js -u ${{ inputs.urls }} ${{ env.BADGES_ARGS }} -o ${{ inputs.results-type }}
          cp -r ${{ inputs.results-type }} ../${{ env.RESULTS_PATH }}
          rm -R ${{ inputs.results-type }}
        fi
        cd ..
      shell: bash
    - name: Commit Results
      run: |
        git config --local user.email ${{ inputs.user-email }}
        git config --local user.name ${{ inputs.user-name }}
        git pull
        git add ${{ env.RESULTS_PATH }}
        git commit -am "${{ inputs.commit-message }}"
        git push
      shell: bash
